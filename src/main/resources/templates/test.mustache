<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
        }

        .cancel-button {
            background-color: #f44336;
        }

        .status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        .waiting {
            background-color: #fff3cd;
            color: #856404;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        #chat-container {
            display: none;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .chat-header {
            background-color: #f8f9fa;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f9f9f9;
        }

        .chat-input {
            display: flex;
            border-top: 1px solid #ddd;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: none;
        }

        .chat-input button {
            width: auto;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 10px;
            max-width: 70%;
        }

        .message-received {
            background-color: #e9e9eb;
            margin-right: auto;
        }

        .message-sent {
            background-color: #dcf8c6;
            margin-left: auto;
            text-align: right;
        }

        .system-message {
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 10px 0;
        }
    </style>
</head>
<body>
<div id="login-container" class="container">
    <h2>로그인</h2>
    <div class="form-group">
        <label for="userId">아이디</label>
        <input type="text" id="userId" placeholder="아이디를 입력하세요">
    </div>
    <div class="form-group">
        <label for="password">비밀번호</label>
        <input type="password" id="password" placeholder="비밀번호를 입력하세요">
    </div>
    <button id="login-btn">로그인</button>
    <div id="login-status" class="status"></div>
</div>

<div id="matching-container" class="container" style="display: none;">
    <h2>랜덤 매칭</h2>
    <div id="user-info"></div>
    <button id="start-matching-btn">매칭 시작</button>
    <button id="cancel-matching-btn" class="cancel-button" style="display: none;">매칭 취소</button>
    <div id="matching-status" class="status"></div>
</div>

<div id="chat-container">
    <div class="chat-header">
        <div>
            <h3>채팅방</h3>
            <div id="partner-info"></div>
        </div>
        <button id="leave-chat-btn" class="cancel-button">나가기</button>
    </div>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input">
        <input type="text" id="message-input" placeholder="메시지를 입력하세요...">
        <button id="send-message-btn">전송</button>
    </div>
</div>

<script>
    // 전역 변수
    let currentUser = {};
    let partnerUser = {};
    let matchingId = null;
    let stompClient = null;
    let statusCheckInterval = null;
    let authToken = null;

    // DOM 요소
    const loginContainer = document.getElementById('login-container');
    const matchingContainer = document.getElementById('matching-container');
    const chatContainer = document.getElementById('chat-container');
    const userInfo = document.getElementById('user-info');
    const partnerInfo = document.getElementById('partner-info');
    const loginStatus = document.getElementById('login-status');
    const matchingStatus = document.getElementById('matching-status');
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');

    // 페이지 로드시 실행
    document.addEventListener('DOMContentLoaded', function() {
        // 로컬 스토리지에서 토큰 확인
        authToken = localStorage.getItem('authToken');
        const userId = localStorage.getItem('userId');

        if (authToken && userId) {
            fetchUserInfo(userId);
        }

        // 이벤트 리스너 설정
        document.getElementById('login-btn').addEventListener('click', login);
        document.getElementById('start-matching-btn').addEventListener('click', startMatching);
        document.getElementById('cancel-matching-btn').addEventListener('click', cancelMatching);
        document.getElementById('leave-chat-btn').addEventListener('click', leaveChat);
        document.getElementById('send-message-btn').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });
    });

    // 로그인 함수
    function login() {
        const userId = document.getElementById('userId').value;
        const password = document.getElementById('password').value;

        if (!userId || !password) {
            loginStatus.textContent = '아이디와 비밀번호를 입력하세요';
            loginStatus.className = 'status error';
            return;
        }

        fetch('http://localhost:8080/user/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId, password})
        })
        .then(response => {
            // 헤더에서 토큰 추출
            authToken = response.headers.get('authorization');
            if (authToken) {
                localStorage.setItem('authToken', authToken);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'OK') {
                localStorage.setItem('userId', data.data);
                fetchUserInfo(data.data);
            } else {
                loginStatus.textContent = data.message || '로그인 실패';
                loginStatus.className = 'status error';
            }
        })
        .catch(error => {
            loginStatus.textContent = '로그인 요청 실패';
            loginStatus.className = 'status error';
        });
    }

    // 사용자 정보 가져오기
    function fetchUserInfo(userId) {
        fetch(`http://localhost:8080/user/find/${userId}`, {
            headers: {'Authorization': authToken}
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'OK') {
                currentUser = data.data;
                userInfo.innerHTML = `
                    <p><strong>닉네임:</strong> ${currentUser.nickName}</p>
                    <p><strong>학번:</strong> ${currentUser.stdNo}</p>
                    <p><strong>학과:</strong> ${currentUser.major}</p>
                `;

                loginContainer.style.display = 'none';
                matchingContainer.style.display = 'block';
            } else {
                alert('사용자 정보를 가져오는데 실패했습니다.');
            }
        });
    }

    // 매칭 시작
    function startMatching() {
        document.getElementById('start-matching-btn').disabled = true;
        document.getElementById('cancel-matching-btn').style.display = 'block';
        matchingStatus.className = 'status waiting';
        matchingStatus.textContent = '매칭 대기 중...';

        const matchingData = {
            userId: currentUser.userId,
            stdNo: currentUser.stdNo,
            nickName: currentUser.nickName,
            univ: currentUser.univ,
            major: currentUser.major,
            gender: currentUser.gender,
            mbti: currentUser.mbti
        };

        fetch('http://localhost:8080/chat/matching', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': authToken
            },
            body: JSON.stringify(matchingData)
        })
        .then(response => response.json())
        .then(data => {
            statusCheckInterval = setInterval(checkMatchingStatus, 2000);
        })
        .catch(() => {
            matchingStatus.className = 'status error';
            matchingStatus.textContent = '매칭 요청 실패';
            document.getElementById('start-matching-btn').disabled = false;
            document.getElementById('cancel-matching-btn').style.display = 'none';
        });
    }

    // 매칭 취소
    function cancelMatching() {
        fetch(`http://localhost:8080/chat/matching/cancel/${currentUser.userId}`, {
            headers: {'Authorization': authToken}
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(statusCheckInterval);
            matchingStatus.className = '';
            matchingStatus.textContent = '';
            document.getElementById('start-matching-btn').disabled = false;
            document.getElementById('cancel-matching-btn').style.display = 'none';
        });
    }

    // 매칭 상태 확인
    function checkMatchingStatus() {
        fetch(`http://localhost:8080/chat/matching/status/${currentUser.userId}`, {
            headers: {'Authorization': authToken}
        })
        .then(response => response.json())
        .then(data => {
            console.log("매칭 상태 응답:", data); // 디버깅용 로그

            // 매칭 성공 여부 확인 (API 응답에서 matched 속성 사용)
            if (data.matched) {
                clearInterval(statusCheckInterval);
                matchingStatus.className = 'status success';
                matchingStatus.textContent = '매칭 성공!';

                matchingId = data.data.matchingId;

                if (data.data.firstUser.userId === currentUser.userId) {
                    partnerUser = data.data.secondUser;
                } else {
                    partnerUser = data.data.firstUser;
                }

                partnerInfo.textContent = `상대방: ${partnerUser.nickName} (${partnerUser.major})`;
                matchingContainer.style.display = 'none';
                chatContainer.style.display = 'block';

                const systemMessage = document.createElement('div');
                systemMessage.className = 'system-message';
                systemMessage.textContent = `${partnerUser.nickName}님과 연결되었습니다.`;
                chatMessages.appendChild(systemMessage);

                connectWebSocket();
            }
        });
    }

    // 채팅방 나가기
    function leaveChat() {
        fetch(`http://localhost:8080/chat/matching/cancel/${currentUser.userId}`, {
            headers: {'Authorization': authToken}
        })
        .then(response => response.json())
        .then(data => {
            if (stompClient) stompClient.disconnect();

            chatContainer.style.display = 'none';
            matchingContainer.style.display = 'block';
            document.getElementById('start-matching-btn').disabled = false;
            document.getElementById('cancel-matching-btn').style.display = 'none';
            matchingStatus.className = '';
            matchingStatus.textContent = '';
            chatMessages.innerHTML = '';
            messageInput.value = '';
            matchingId = null;
        });
    }

    // 웹소켓 연결
    function connectWebSocket() {
        const socket = new SockJS('/chat-connect');
        stompClient = Stomp.over(socket);

        const headers = {};
        if (authToken) {
            headers['Authorization'] = authToken;
        }

        stompClient.connect(headers, function(frame) {
            stompClient.subscribe(`/sub/chat.${matchingId}`, function(message) {
                const received = JSON.parse(message.body);

                // 연결 종료 메시지 처리
                if(received.status === "OK" && received.matched === false) {
                    const systemMessage = document.createElement('div');
                    systemMessage.className = 'system-message';
                    systemMessage.textContent = received.message || "채팅이 종료되었습니다.";
                    chatMessages.appendChild(systemMessage);

                    setTimeout(() => {
                        if (stompClient) stompClient.disconnect();
                        chatContainer.style.display = 'none';
                        matchingContainer.style.display = 'block';
                        document.getElementById('start-matching-btn').disabled = false;
                        matchingStatus.textContent = '';
                    }, 3000);
                    return;
                }

                // 일반 메시지 표시
                displayMessage(received);
            });
        });
    }

    // 메시지 전송
    function sendMessage() {
        const messageContent = messageInput.value.trim();
        if (messageContent && stompClient) {
            const chatMessage = {
                senderUserId: currentUser.userId,
                receiverUserId: partnerUser.userId,
                message: messageContent,
                date: new Date().toISOString()
            };

            stompClient.send(`/pub/chat.${matchingId}`, {}, JSON.stringify(chatMessage));
            messageInput.value = '';
        }
    }

    // 메시지 표시
    function displayMessage(message) {
        const messageElement = document.createElement('div');
        const isSentByMe = message.senderUserId === currentUser.userId;

        messageElement.className = `message ${isSentByMe ? 'message-sent' : 'message-received'}`;
        messageElement.innerHTML = `
            <div>
                <div style="font-size: 12px; color: #777;">${isSentByMe ? '나' : partnerUser.nickName}</div>
                <div>${message.message}</div>
            </div>
        `;

        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
</script>
</body>
</html>